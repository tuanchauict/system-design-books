<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yelp System Design Interview Guide</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div><div class="flex flex-col gap-2 md:gap-4"><div class="flex flex-col"><h6 class="MuiTypography-root MuiTypography-h6 mui-zfm63x">Common Problems</h6><h1 class="MuiTypography-root MuiTypography-h2 mui-161snwm">Design a Business Review Service like Yelp</h1></div><div class="flex flex-col md:flex-row gap-2 md:items-center justify-between"><div class="flex flex-col lg:flex-row gap-4 md:items-center"><a target="_blank" rel="noopener noreferrer" class="flex flex-row gap-2 items-center" href="https://www.linkedin.com/in/evan-king-40072280/" style="text-decoration: none;"><img class="rounded-full" src="https://hellointerview-files.s3.us-west-2.amazonaws.com/public-media/evan-headshot.png" alt="Evan King" width="40" height="40"><div class="flex flex-col"><div class="flex flex-row gap-2 items-center"><p class="MuiTypography-root MuiTypography-body2 mui-ltrqv0">Evan King</p><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeInherit mui-70s7oy" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="LinkedInIcon"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"></path></svg></div><span class="MuiTypography-root MuiTypography-caption mui-1eozzb8">Ex-Meta Staff Engineer</span></div></a><div class="flex flex-row gap-4 md:gap-8 items-center"><div class="flex flex-row gap-1 items-center" aria-label="Difficulty"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-5 h-5 text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0 1 12 21 8.25 8.25 0 0 1 6.038 7.047 8.287 8.287 0 0 0 9 9.601a8.983 8.983 0 0 1 3.361-6.867 8.21 8.21 0 0 0 3 2.48Z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 0 0 .495-7.468 5.99 5.99 0 0 0-1.925 3.547 5.975 5.975 0 0 1-2.133-1.001A3.75 3.75 0 0 0 12 18Z"></path></svg><p class="MuiTypography-root MuiTypography-body2 mui-su24yt">medium</p></div><div class="flex flex-row gap-1 items-center" aria-label="Average time allowed in interview"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-5 h-5 text-gray-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path></svg><p class="MuiTypography-root MuiTypography-body2 mui-1pb8xyp">35 min</p></div></div></div><a class="MuiButtonBase-root MuiButton-root MuiButton-contained MuiButton-containedPrimary MuiButton-sizeSmall MuiButton-containedSizeSmall MuiButton-colorPrimary MuiButton-disableElevation MuiButton-root MuiButton-contained MuiButton-containedPrimary MuiButton-sizeSmall MuiButton-containedSizeSmall MuiButton-colorPrimary MuiButton-disableElevation mui-1c7cv5a" tabindex="0" href="/practice/system-design/start/yelp" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-5 h-5 mr-1"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672ZM12 2.25V4.5m5.834.166-1.591 1.591M20.25 10.5H18M7.757 14.743l-1.59 1.59M6 10.5H3.75m4.007-4.243-1.59-1.59"></path></svg>Practice this problem<span class="MuiTouchRipple-root mui-w0pj6f"></span></a></div></div><hr class="MuiDivider-root MuiDivider-fullWidth mui-1rvhejo"></div>
<h2 class="MuiTypography-root MuiTypography-h3 mui-1rzqq5q" id="understanding-the-problem">Understanding the Problem</h2>
<div class="my-6"><div class="MuiBox-root mui-1fz7ihe"><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag"><strong>üçΩÔ∏è What is <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.yelp.com/" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Yelp</a>?</strong>
Yelp is an online platform that allows users to search for and review local businesses, restaurants, and services.</div></div></div></div></div>
<h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="functional-requirements"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/in-a-hurry/delivery#1-functional-requirements" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Functional Requirements</a></h3>
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Some interviewers will start the interview by outlining the core functional requirements for you. Other times, you'll be tasked with coming up with them yourself. If you've used the product before, this should be relatively straight forward. However, if you haven't, it's a good idea to ask some questions of your interviewer to better understand the system.</div>
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Here is the set of functional requirements we'll focus on in this breakdown (this is also the set of requirements I lead candidates to when asking this question in an interview)</div>
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag"><strong>Core Requirements</strong></div>
<ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Users should be able to search for businesses by name, location (lat/long), and category</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Users should be able to view businesses (and their reviews)</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Users should be able to leave reviews on businesses (mandatory 1-5 star rating and optional text)</div></li>
</ol>
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag"><strong>Below the line (out of scope):</strong></div>
<ul class="MuiList-root MuiList-padding mui-sedpvs">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Admins should be able to add, update, and remove businesses (we will focus just on the user)</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Users should be able to view businesses on a map</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Users should be recommended businesses relevant to them</div></li>
</ul>
<h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="non-functional-requirements"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/in-a-hurry/delivery#2-non-functional-requirements" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Non-Functional Requirements</a></h3>
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag"><strong>Core Requirements</strong></div>
<ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The system should have low latency for search operations (&lt; 500ms)</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The system should be highly available, eventual consistency is fine</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The system should be scalable to handle 100M daily users and 10M businesses</div></li>
</ol>
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag"><strong>Below the line (out of scope):</strong></div>
<ul class="MuiList-root MuiList-padding mui-sedpvs">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The system should protect user data and adhere to GDPR</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The system should be fault tolerant</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The system should protect against spam and abuse</div></li>
</ul>
<div class="my-6"><div class="MuiBox-root mui-1147lff"><div class="MuiBox-root mui-zvu67g"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-6 h-6 heroicon-sw-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path></svg></div><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">If you're someone who often struggles to come up with your non-functional requirements, take a look at this list of <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/in-a-hurry/delivery#2-non-functional-requirements" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">common non-functional requirements</a> that should be considered. Just remember, most systems are all these things (fault tolerant, scalable, etc) but your goal is to identify the unique characteristics that make this system challenging or unique.</div></div></div></div></div>
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Here is what you might write on the whiteboard:</div>
<div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/9d16b1040c15c907c0262c4c8944c9c3" alt="Yelp Non-Functional Requirements"></div></div></div><div class="MuiGrid-root MuiGrid-item mui-1wxaqej"><span class="MuiTypography-root MuiTypography-caption mui-17cupi8">Yelp Non-Functional Requirements</span></div></div></div></div>
<div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="constraints">Constraints</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Depending on the interview, your interviewer may introduce a set of additional constraints. If you're a senior+ candidate, spend some time in the interview to identify these constraints and discuss them with your interviewer.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">When I ask yelp, I'll introduce the constraint that <strong>each user can only leave one review per business.</strong></div><h2 class="MuiTypography-root MuiTypography-h3 mui-1rzqq5q" id="the-set-up">The Set Up</h2><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="defining-the-core-entities"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/in-a-hurry/delivery#core-entities-2-minutes" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Defining the Core Entities</a></h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We recommend that you start with a broad overview of the primary entities. At this stage, it is not necessary to know every specific column or detail. We will focus on the intricacies, such as columns and fields, later when we have a clearer grasp. Initially, establishing these key entities will guide our thought process and lay a solid foundation as we progress towards defining the API.</div><div class="my-6"><div class="MuiBox-root mui-1147lff"><div class="MuiBox-root mui-zvu67g"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-6 h-6 heroicon-sw-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path></svg></div><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Just make sure that you let your interviewer know your plan so you're on the same page. I'll often explain that I'm going to start with just a simple list, but as we get to the high-level design, I'll document the data model more thoroughly.</div></div></div></div></div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To satisfy our key functional requirements, we'll need the following entities:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Business</strong>: Represents a business or service listed on Yelp. Includes details like name, location, category, and average rating.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>User</strong>: Represents a Yelp user who can search for businesses and leave reviews.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Review</strong>: Represents a review left by a user for a business, including rating and optional text.</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">In the actual interview, this can be as simple as a short list like this. Just make sure you talk through the entities with your interviewer to ensure you are on the same page.</div><div class="my-4 flex-col w-full max-w-[200px]"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/9513380859d747c40047955f738f20d2" alt="Yelp Entities"></div></div></div><div class="MuiGrid-root MuiGrid-item mui-1wxaqej"><span class="MuiTypography-root MuiTypography-caption mui-17cupi8">Yelp Entities</span></div></div></div></div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="the-api"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/in-a-hurry/delivery#4-api-or-system-interface" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">The API</a></h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The next step in the framework is to define the APIs of the system. This sets up a contract between the client and the server, and it's the first point of reference for the high-level design.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Your goal is to simply go one-by-one through the core requirements and define the APIs that are necessary to satisfy them. Usually, these map 1:1 to the functional requirements, but there are times when multiple endpoints are needed to satisfy an individual functional requirement.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To search for businesses, we'll need a GET endpoint that takes in a set of search parameters and returns a list of businesses.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span>// Search for businesses
</span>GET /businesses?query&amp;location&amp;category&amp;page -&gt; Business[]</code></div></div></pre><div class="my-6"><div class="MuiBox-root mui-1147lff"><div class="MuiBox-root mui-zvu67g"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-6 h-6 heroicon-sw-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path></svg></div><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Whenever you have an endpoint that can return a large set of results, you should consider adding pagination to it. This minimizes the payload size and makes the system more responsive.</div></div></div></div></div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To view a business and its reviews, we'll need a GET endpoint that takes in a business ID and returns the business details and its reviews.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span>// View business details and reviews
</span>GET /businesses/:businessId -&gt; Business &amp; Review[]</code></div></div></pre><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">While this endpoint is enough, you could also split the business and reviews into two separate endpoints. This way we can have pagination on the reviews.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span>// View business details
</span>GET /businesses/:businessId -&gt; Business

// View reviews for a business
GET /businesses/:businessId/reviews?page= -&gt; Review[]</code></div></div></pre><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To leave a review, we'll need a POST endpoint that takes in the business ID, the user ID, the rating, and the optional text, and creates a review.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span>// Leave a review
</span>POST /businesses/:businessId/reviews
{
  rating: number,
  text?: string
}</code></div></div></pre><h2 class="MuiTypography-root MuiTypography-h3 mui-1rzqq5q" id="high-level-design"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/in-a-hurry/delivery#high-level-design-10-15-minutes" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">High-Level Design</a></h2><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We'll start our design by going one-by-one through our functional requirements and designing a single system to satisfy them. Once we have this in place, we'll layer on depth via our deep dives.</div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="1-users-should-be-able-to-search-for-businesses">1) Users should be able to search for businesses</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The first thing users do when they visit a Yelp-like site is search for a business. Search includes any combination of name or term, location, and category like restaurants, bars, coffee shops, etc.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We already layed out our API above of <span class="MuiBox-root mui-1vu004u">GET /businesses?query&amp;location&amp;category&amp;page</span>, now we just need to draw out a basic architecture that can satisfy this incoming request.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To enable users to search for businesses, we'll start with a basic architecture:</div><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/889338a8e942c3bb6ec741a1fa1b2f0f" alt="Yelp High-Level Design"></div></div></div><div class="MuiGrid-root MuiGrid-item mui-1wxaqej"><span class="MuiTypography-root MuiTypography-caption mui-17cupi8">Yelp High-Level Design</span></div></div></div></div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Client</strong>: Users interact with the system through a web or mobile application.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>API Gateway</strong>: Routes incoming requests to the appropriate services. In this case, the Business Service.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Business Service</strong>: Handles incoming search requests by processing query parameters and formulating database queries to retrieve relevant business information.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Database</strong>: Stores information about businesses such as name, description, location, category, etc.</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">When a user searches for a business:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The client sends a GET request to <span class="MuiBox-root mui-1vu004u">/businesses</span> with the search parameters as optional query params.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The API Gateway routes this request to the Business Service.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The Business Service queries the Database based on the search criteria.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The results are returned to the client via the API Gateway.</div></li>
</ol><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="2-users-should-be-able-to-view-businesses">2) Users should be able to view businesses</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Once users have submitted their search, they'll be viewing a list of businesses via the search results page. The next user action is to click on a business to view it's details.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Once they do, the client will issue a <span class="MuiBox-root mui-1vu004u">GET /businesses/:businessId</span> request to the API Gateway.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To handle this, we don't need to introduce any additional services. We can just have the API Gateway route the request to the Business Service. The Business Service will query the Database for the business details and then the reviews. For now, we'll keep reviews in the same database as the businesses, but we'll need to make sure to join the two tables.</div><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/123fc92acfb329974cbe1e86164098d4" alt="Yelp High-Level Design"></div></div></div><div class="MuiGrid-root MuiGrid-item mui-1wxaqej"><span class="MuiTypography-root MuiTypography-caption mui-17cupi8">Yelp High-Level Design</span></div></div></div></div><div class="my-6"><div class="MuiBox-root mui-1147lff"><div class="MuiBox-root mui-zvu67g"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-6 h-6 heroicon-sw-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path></svg></div><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">A common question I receive is when to separate services. There is no hard and fast rule, but the main criteria I will use are (a) whether the functionality is closely related and (b) whether the services need to scale independently due to vastly different read/write patterns.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">In this case, viewing a business and searching for a business are closely related, and the read patterns are similar (both read-heavy), so it makes sense to have this logic as part of the same service for now.</div></div></div></div></div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">When a user views a business:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The client sends a GET request to <span class="MuiBox-root mui-1vu004u">/businesses/:businessId</span>.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The API Gateway routes this to the Business Service.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The Business Service retrieves business details and reviews from the Database.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The combined information is returned to the client.</div></li>
</ol><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="3-users-should-be-able-to-leave-reviews-on-businesses">3) Users should be able to leave reviews on businesses</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Lastly, given this is a review site, users will also want to leave reviews on businesses. This is just a mandatory 1-5 star rating and an optional text field. We won't worry about the constraints that a user can only leave one review per business yet, we'll handle that in our deep dives.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We'll need to introduce one new service, the Review Service. This will handle the creation and management of reviews. We separate this into a different service mainly because the usage pattern is significantly different. Users search/view for businesses a lot, but they hardly ever leave reviews. This insight actually becomes fairly crucial later on in the design, stay tuned.</div><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/d0656e726298630e48949698b5f03b35" alt="Yelp High-Level Design"></div></div></div><div class="MuiGrid-root MuiGrid-item mui-1wxaqej"><span class="MuiTypography-root MuiTypography-caption mui-17cupi8">Yelp High-Level Design</span></div></div></div></div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">When a user leaves a review:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The client sends a POST request to <span class="MuiBox-root mui-1vu004u">/businesses/:businessId/reviews</span> with the review data.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The API Gateway routes this to the Review Service.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">The Review Service stores it in the Database.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">A confirmation is sent back to the client.</div></li>
</ol><div class="my-6"><div class="MuiBox-root mui-8d9r5j"><div class="MuiBox-root mui-3t6lyr"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-6 h-6 heroicon-sw-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path></svg></div><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Should we separate the review data into its own database? Aren't all microservices supposed to have their own database?</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The answer to this question is a resounding maybe. There are some microservice zealots who will argue this point incessantly, but the reality is that many systems, use the same database for multiple purposes and it's often times the simpler and, arguably, correct answer.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">In this case, we have a very tiny amount of data, <span class="MuiBox-root mui-1vu004u">10M businesses x 100 reviews each = 1TB</span>. Modern databases can handle this easily in a single instance, so we don't even need to worry about sharding. Additionally, reviews and businesses are tightly coupled and we don't want to have to join across services to get the business details and reviews.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The counter argument is typically related to fault isolation and operational responsibility. We want to make sure that if the review database goes offline, we aren't left unable to search or view businesses. While this is a valid concern, we can mitigate it via other means like simple replication.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">At the end of the day, it's a discussion of trade-offs with no single correct answer. I bias toward simplicity unless I can articulate a clear benefit to adding complexity and suggest you do the same if not already strongly principled on the matter.</div></div><div class="MuiBox-root mui-fx3t84"></div><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textError MuiButton-sizeSmall MuiButton-textSizeSmall MuiButton-colorError MuiButton-disableElevation MuiButton-root MuiButton-text MuiButton-textError MuiButton-sizeSmall MuiButton-textSizeSmall MuiButton-colorError MuiButton-disableElevation mui-tggf3w" tabindex="0" type="button">Show More<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button></div></div></div><h2 class="MuiTypography-root MuiTypography-h3 mui-1rzqq5q" id="potential-deep-dives"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/in-a-hurry/delivery#deep-dives-10-minutes" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Potential Deep Dives</a></h2><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">At this point, we have a basic, functioning system that satisfies the functional requirements. However, there are a number of areas we could dive deeper into to improve the system's performance, scalability, and fault tolerance. Depending on your seniority, you'll be expected to drive the conversation toward these deeper topics of interest.</div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="1-how-would-you-efficiently-calculate-and-update-the-average-rating-for-businesses-to-ensure-its-readily-available-in-search-results">1) How would you efficiently calculate and update the average rating for businesses to ensure it's readily available in search results?</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">When users search for businesses, we don't show the full business details of course in the search results. Instead, we show partial data including things like the business name, location, and category. Importantly, we also want to show users the average rating of the business since this is often the first thing they look at when deciding on a business to visit.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Calculating the average rating on the fly for every search query would be terribly inefficient. Let's dive into a few approaches that can optimize this.</div><div class="my-6 flex flex-col gap-4"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-ifi55z"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-1ev8i4f" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Bad Solution: Naive Approach</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">As alluded to, the simplest approach is to calculate the average rating on the fly. This is simple and requires no additional data or infrastructure.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We'd simply craft a query that joins the businesses and reviews and then calculates the average rating for each business.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(166, 38, 164);">SELECT</span><span>
</span><span>  b</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>business_id</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>  b</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>name</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>  b</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>location</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>  b</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>category</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>  </span><span class="token" style="color: rgb(64, 120, 242);">AVG</span><span class="token" style="color: rgb(56, 58, 66);">(</span><span>r</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>rating</span><span class="token" style="color: rgb(56, 58, 66);">)</span><span> </span><span class="token" style="color: rgb(166, 38, 164);">AS</span><span> average_rating
</span><span></span><span class="token" style="color: rgb(166, 38, 164);">FROM</span><span> businesses b
</span><span></span><span class="token" style="color: rgb(166, 38, 164);">JOIN</span><span> reviews r </span><span class="token" style="color: rgb(166, 38, 164);">ON</span><span> b</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>business_id </span><span class="token" style="color: rgb(64, 120, 242);">=</span><span> r</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>business_id
</span><span></span><span class="token" style="color: rgb(166, 38, 164);">GROUP</span><span> </span><span class="token" style="color: rgb(166, 38, 164);">BY</span><span> b</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>business_id</span><span class="token" style="color: rgb(56, 58, 66);">;</span></code></div></div></pre><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="challenges">Challenges</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">While this approach is simple, it has significant scalability issues:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Performance degradation: As the number of reviews grows, this query becomes increasingly expensive. The JOIN operation between businesses and reviews tables can be particularly costly, especially for popular businesses with thousands or millions of reviews.</div>
</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Unnecessary recalculation: The average rating is recalculated for every search query, even if no new reviews have been added since the last calculation. This is computationally wasteful.</div>
</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Impact on read operations: Constantly running this heavy query for every search can significantly slow down other read operations on the database, affecting overall system performance.</div>
</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Given our scale of 100M daily users and 10M businesses, this naive approach would likely lead to unacceptable performance and user experience issues.</div></div></div></div></div></div></div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-nhbct3"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-guv1gb" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Good Solution: Periodic Update with Cron Job</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach-1">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Alternatively, we could pre-compute the average rating for each business and store it in the database. This pre-computation can be done using a cron job that runs periodically (e.g., once a day, once an hour, etc). The cron job would query the reviews table, calculate the average rating for each business, and update a new average_rating column in the businesses table.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Now, anytime we search or query a business, we can simply read the average_rating from the database.</div><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/5a0b1b80d62dfcf646dc1ff564075607"></div></div></div></div></div></div><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="challenges-1">Challenges</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The main downside with this approach is that it does not account for real-time changes in reviews. You can imagine a business with very few reviews and a currently low average rating. If you give the business a 5-star rating, your expectation would be that the average rating increases to reflect your vote. However, since we're recalculating the average rating periodically, this may not happen for hours or even days, leading to a stale average rating and confused users.</div></div></div></div></div></div></div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-11r69q9"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-3ujfba" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Great Solution: Synchronous Update with Optimistic Locking</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach-2">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Our goal with the great solution is to make sure we can update the average rating as we receive new reviews rather than periodically via a cron job. Doing this is relatively straight forward in that we simply need to both add the new review to the Review table while also updating the average rating for the business in the Business table.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To make that update efficient, we can introduce a new column, <span class="MuiBox-root mui-1vu004u">num_reviews</span>, into the Business table. Now, to update an average rating, we simple calculate <span class="MuiBox-root mui-1vu004u">(old_rating * num_reviews + new_rating) / (num_reviews + 1)</span>, which is cheap, just a few CPU cycles so it can be done synchronously for each new review.</div><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/7d6d8600941b7a6394d1a69b3f9a153d"></div></div></div></div></div></div><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="challenges-2">Challenges</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">In doing this, we've actually introduced a new problem. What happens if multiple reviews come in at the same time for the same business? One could overwrite the other, leading to an inconsistent state!</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Let's imagine a timeline of events:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Business A has 100 reviews with an average rating of 4.0</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">User 1 reads the current state: num_reviews = 100, avg_rating = 4.0</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">User 2 also reads the current state: num_reviews = 100, avg_rating = 4.0</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">User 1 submits a 5-star review and calculates:
new_avg = (4.0 * 100 + 5) / 101 ‚âà 4.01</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">User 2 submits a 3-star review and calculates:
new_avg = (4.0 * 100 + 3) / 101 ‚âà 3.99</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">User 1's update completes: num_reviews = 101, avg_rating = 4.01</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">User 2's update overwrites: num_reviews = 101, avg_rating = 3.99</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The final state (num_reviews = 101, avg_rating = 3.99) is incorrect because it doesn't account for User 1's 5-star review. The correct average should be:
(4.0 * 100 + 5 + 3) / 102 ‚âà 4.00</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To solve this issue, we can use optimistic locking. Optimistic locking is a technique where we first read the current state of the business and then attempt to update it. If the state has changed since we read it, our update fails. We'll often add a version number to the table you want to lock on, but in our case, we can just check if the number of reviews has changed.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Now, when user 2 would have overwritten user 1's review, our update will fail because the number of reviews has changed. User 2 will have to read the state again and recalculate the average rating. This solves the problem of concurrent updates and ensures the average rating is always up to date and consistent.</div></div></div></div></div></div></div></div><div class="my-6"><div class="MuiBox-root mui-8d9r5j"><div class="MuiBox-root mui-3t6lyr"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-6 h-6 heroicon-sw-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path></svg></div><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">What about a message queue? Whenever I ask this question, particularly of senior candidates, most will propose we write incoming reviews to a message queue and then have a consumer update the average rating in a separate service. While this is a decent answer, it's important to note that this introduces additional complexity that, it can be argued, is not necessary given the right volume.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">As we pointed out early, many people search/review businesses but very few actually leave reviews. We can estimate this read:write ratio at as much as 1000:1. With 100M users, that would mean only 100k writes per day, or 1 write per second. This is tiny. Modern databases can handle thousands of writes per second, so even accounting for surges, this will almost never be a problem.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Calling this out is the hallmark of a staff candidate and is a perfect example of where simplicity actually demonstrates seniority.</div></div><div class="MuiBox-root mui-fx3t84"></div><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textError MuiButton-sizeSmall MuiButton-textSizeSmall MuiButton-colorError MuiButton-disableElevation MuiButton-root MuiButton-text MuiButton-textError MuiButton-sizeSmall MuiButton-textSizeSmall MuiButton-colorError MuiButton-disableElevation mui-tggf3w" tabindex="0" type="button">Show More<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button></div></div></div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="2-how-would-you-modify-your-system-to-ensure-that-a-user-can-only-leave-one-review-per-business">2) How would you modify your system to ensure that a user can only leave one review per business?</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We need to implement a constraint that allows users to leave only one review per business. This constraint serves as a basic measure to prevent spam and abuse. For example, it stops competitors from repeatedly leaving negative reviews (such as 1-star ratings) on their rivals' businesses.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Here are some options.</div><div class="my-6 flex flex-col gap-4"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-ifi55z"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-1ev8i4f" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Bad Solution: Application-level Check</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach-3">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The most basic option is to simply check if the user has already reviewed the business in the application layer, only writing the database if they haven't and returning an error otherwise. This is typically the solution I see mid-level (and often senior) candidates propose first.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Some simple pseudo code:</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(166, 38, 164);">def</span><span> </span><span class="token" style="color: rgb(64, 120, 242);">leave_review</span><span class="token" style="color: rgb(56, 58, 66);">(</span><span>user_id</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span> business_id</span><span class="token" style="color: rgb(56, 58, 66);">)</span><span class="token" style="color: rgb(56, 58, 66);">:</span><span>
</span><span>    reviews_for_business </span><span class="token" style="color: rgb(64, 120, 242);">=</span><span> db</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>get_reviews_for_business</span><span class="token" style="color: rgb(56, 58, 66);">(</span><span>business_id</span><span class="token" style="color: rgb(56, 58, 66);">)</span><span>
</span><span>    </span><span class="token" style="color: rgb(166, 38, 164);">if</span><span> user_id </span><span class="token" style="color: rgb(166, 38, 164);">in</span><span> reviews_for_business</span><span class="token" style="color: rgb(56, 58, 66);">:</span><span>
</span><span>        </span><span class="token" style="color: rgb(166, 38, 164);">return</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"User has already reviewed this business"</span><span>
</span><span>    </span><span class="token" style="color: rgb(166, 38, 164);">else</span><span class="token" style="color: rgb(56, 58, 66);">:</span><span>
</span><span>        db</span><span class="token" style="color: rgb(56, 58, 66);">.</span><span>leave_review</span><span class="token" style="color: rgb(56, 58, 66);">(</span><span>user_id</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span> business_id</span><span class="token" style="color: rgb(56, 58, 66);">)</span></code></div></div></pre><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="challenges-3">Challenges</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The main issue with the approach is that it's not robust to changes. The reality is that as the company grows there may be other services that also write reviews, Data Engineers running backfills, etc. In any of these cases, these new actors are likely to not be aware of your application-layer constraint and may violate it.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Less importantly, we've also introduced a potential race condition. If the same user submits two reviews at the same time, it's possible that both pass the check and you end up with two reviews, violating our constraint.</div></div></div></div></div></div></div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-11r69q9"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-3ujfba" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Great Solution: Database Constraint</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach-4">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The right way to handle this is via a database constraint, effectively enforcing the constraint at the database engine level. This can be done via a unique constraint on the <span class="MuiBox-root mui-1vu004u">user_id</span> and <span class="MuiBox-root mui-1vu004u">business_id</span> fields.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(166, 38, 164);">ALTER</span><span> </span><span class="token" style="color: rgb(166, 38, 164);">TABLE</span><span> reviews
</span><span></span><span class="token" style="color: rgb(166, 38, 164);">ADD</span><span> </span><span class="token" style="color: rgb(166, 38, 164);">CONSTRAINT</span><span> unique_user_business </span><span class="token" style="color: rgb(166, 38, 164);">UNIQUE</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">(</span><span>user_id</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span> business_id</span><span class="token" style="color: rgb(56, 58, 66);">)</span><span class="token" style="color: rgb(56, 58, 66);">;</span></code></div></div></pre><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Now, it's impossible to violate our constraint because the database will throw an error if we try to insert a duplicate. We just need to handle that error gracefully and send it back to the client. In the case of the race condition we mentioned earlier, there will always be one winner (as long as the data is on the same database instance, which it should be). The write attempt that ends up being processed second will throw a unique constraint error.</div></div></div></div></div></div></div></div><div class="my-6"><div class="MuiBox-root mui-1147lff"><div class="MuiBox-root mui-zvu67g"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-6 h-6 heroicon-sw-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"></path></svg></div><div class="MuiBox-root mui-79elbk"><div style="overflow: hidden; max-height: 300px;"><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Generally speaking, whenever we have a data constraint we want to enforce that constraint as close the persistence layer as possible. This way we can ensure our business logic is always consistent and avoid having to do extra work in the application layer.</div></div></div></div></div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="3-how-can-you-improve-search-to-handle-complex-queries-more-efficiently">3) How can you improve search to handle complex queries more efficiently?</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">This is the crux of the interview and where you'll want to be sure to spend the most time. Search is a fairly complex problem and different interviewers may introduce different constraints or nuances that change the design. I'll walk through a couple of them.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The challenge is that searching by latitude and longitude in a traditional database without a proper indexing is highly inefficient for large datasets. When using simple inequality comparisons (&gt; lat and &lt; lat, &gt; long and &lt; long) to find businesses within a bounding box, the database has to perform a full table scan, checking every single record against these conditions. This is also true when searching for terms in the business name or description. This would require a wild card search across the entire database via a <span class="MuiBox-root mui-1vu004u">LIKE</span> clause.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(160, 161, 167); font-style: italic;">// This query sucks. Very very slow.</span><span>
</span><span></span><span class="token" style="color: rgb(166, 38, 164);">SELECT</span><span> </span><span class="token" style="color: rgb(64, 120, 242);">*</span><span> 
</span><span></span><span class="token" style="color: rgb(166, 38, 164);">FROM</span><span> businesses 
</span><span></span><span class="token" style="color: rgb(166, 38, 164);">WHERE</span><span> latitude </span><span class="token" style="color: rgb(64, 120, 242);">&gt;</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">10</span><span> </span><span class="token" style="color: rgb(64, 120, 242);">AND</span><span> latitude </span><span class="token" style="color: rgb(64, 120, 242);">&lt;</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">20</span><span> 
</span><span></span><span class="token" style="color: rgb(64, 120, 242);">AND</span><span> longitude </span><span class="token" style="color: rgb(64, 120, 242);">&gt;</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">10</span><span> </span><span class="token" style="color: rgb(64, 120, 242);">AND</span><span> longitude </span><span class="token" style="color: rgb(64, 120, 242);">&lt;</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">20</span><span>
</span><span></span><span class="token" style="color: rgb(64, 120, 242);">AND</span><span> name </span><span class="token" style="color: rgb(64, 120, 242);">LIKE</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">'%coffee%'</span><span class="token" style="color: rgb(56, 58, 66);">;</span></code></div></div></pre><div class="my-6 flex flex-col gap-4"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-ifi55z"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-1ev8i4f" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Bad Solution: Basic Database Indexing</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach-5">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The first thing we could do to improve the performance of this query is to add a simple B-tree index on the latitude and longitude columns. Ideally, this would make it faster to find businesses within a bounding box.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(166, 38, 164);">CREATE</span><span> </span><span class="token" style="color: rgb(166, 38, 164);">INDEX</span><span> idx_latitude_longitude </span><span class="token" style="color: rgb(166, 38, 164);">ON</span><span> businesses </span><span class="token" style="color: rgb(56, 58, 66);">(</span><span>latitude</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span> longitude</span><span class="token" style="color: rgb(56, 58, 66);">)</span><span class="token" style="color: rgb(56, 58, 66);">;</span></code></div></div></pre><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="challenges-4">Challenges</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The reality is this approach doesn't work as effectively as we might hope. The simple B-tree index we'd typically use for single-column or composite indexes is not well-optimized for querying 2-dimensional data like latitude and longitude. Here's why:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Range queries: When searching for businesses within a geographic area, we're essentially performing a range query on both latitude and longitude. B-tree indexes are efficient for single-dimension range queries but struggle with multi-dimensional ranges.</div>
</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">
<div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Lack of spatial awareness: B-tree indexes don't understand the spatial relationship between points. They treat latitude and longitude as independent values, which doesn't capture the 2D nature of geographic coordinates.</div>
</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">To truly optimize geographic searches, we need more specialized indexing structures designed for spatial data, such as R-trees, quadtrees, or geohash-based indexes. These structures are specifically built to handle the complexities of 2D (or even 3D) spatial data and can significantly improve the performance of geographic queries.</div></div></div></div></div></div></div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-11r69q9"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-3ujfba" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Great Solution: Elasticsearch</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach-6">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Instead, there are 3 different types of indexing strategies we'll need in order to search of 3, very different types of filters:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Location</strong>: To efficiently search by location we need to use a geospatial index like <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://en.wikipedia.org/wiki/Geohash" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">geohashes</a>, <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://en.wikipedia.org/wiki/Quadtree" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">quadtrees</a>, or <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://en.wikipedia.org/wiki/R-tree" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">R-trees</a>.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Name</strong>: To efficiently search by name we need to use a full text search index which uses a technique called <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://en.wikipedia.org/wiki/Inverted_index" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">inverted indexes</a> to quickly search for terms in a document.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0"><strong>Category</strong>: To efficiently search by category we can use a simple <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://en.wikipedia.org/wiki/B-tree" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">B-tree index</a>.</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">There are several technologies which support all three of these indexing strategies (and more). One common example is <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/learn/system-design/deep-dives/elasticsearch" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Elasticsearch</a>.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Elasticsearch is a search optimized database that is purpose built for fast search queries. It's optimized for handling large datasets and can handle complex queries that traditional databases struggle with making it a perfect fit for our use case.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Elasticsearch supports various geospatial indexing strategies including geohashing, quadtrees, and R-trees, allowing for efficient location-based searches. It also excels at full-text search and category filtering, making it ideal for our multi-faceted search requirements.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We can issue a single search query to Elasticsearch that combines all of our filters and returns a ranked list of businesses.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>  </span><span class="token" style="color: rgb(228, 86, 73);">"query"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>    </span><span class="token" style="color: rgb(228, 86, 73);">"bool"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>      </span><span class="token" style="color: rgb(228, 86, 73);">"must"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">[</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>          </span><span class="token" style="color: rgb(228, 86, 73);">"match"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>            </span><span class="token" style="color: rgb(228, 86, 73);">"name"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"coffee"</span><span>
</span><span>          </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>          </span><span class="token" style="color: rgb(228, 86, 73);">"geo_distance"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>            </span><span class="token" style="color: rgb(228, 86, 73);">"distance"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"10km"</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>            </span><span class="token" style="color: rgb(228, 86, 73);">"location"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>              </span><span class="token" style="color: rgb(228, 86, 73);">"lat"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">40.7128</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>              </span><span class="token" style="color: rgb(228, 86, 73);">"lon"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">-74.0060</span><span>
</span><span>            </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>          </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>          </span><span class="token" style="color: rgb(228, 86, 73);">"term"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>            </span><span class="token" style="color: rgb(228, 86, 73);">"category"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"coffee shop"</span><span>
</span><span>          </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>      </span><span class="token" style="color: rgb(56, 58, 66);">]</span><span>
</span><span>    </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>  </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span></span><span class="token" style="color: rgb(56, 58, 66);">}</span></code></div></div></pre><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/69f845467c9cde83d9968ca14afac6a8"></div></div></div></div></div></div><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="challenges-5">Challenges</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The main challenge you want to be aware of when introducing Elasticsearch is that you won‚Äôt want to use it as a primary database, this is a no-no. It is not optimized to maintain transactional data integrity with full ACID compliance, nor to handle complex transactions. Additionally, Elasticsearch‚Äôs fault tolerance mechanisms, while effective, require careful configuration to avoid potential data loss during node or network failures. It‚Äôs best utilized for what it‚Äôs designed for: search and analytical operations across large datasets, rather than primary data storage.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">As a result, we need a way to ensure the data in Elasticsearch remains in sync (consistent) with our primary database. The best way to do this is to use a <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://en.wikipedia.org/wiki/Change_data_capture" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Change Data Capture</a> (CDC) system to capture changes to the primary database and then apply them to Elasticsearch.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">This works by having all DB changes captured as events and written to a queue or stream. We then have a consumer process that reads from the queue or stream and applies the same changes to Elasticsearch.</div></div></div></div></div></div></div><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation0 MuiAccordion-root MuiAccordion-rounded MuiAccordion-gutters mui-11r69q9"><div class="MuiButtonBase-root MuiAccordionSummary-root MuiAccordionSummary-gutters mui-3ujfba" tabindex="0" role="button" aria-expanded="false" aria-controls="panel1bh-content" id="panel1bh-header"><div class="MuiAccordionSummary-content MuiAccordionSummary-contentGutters mui-l0jafl"><p class="MuiTypography-root MuiTypography-body1 mui-h8owmt">Great Solution: Postgres with Extensions</p></div><div class="MuiAccordionSummary-expandIconWrapper mui-awtdfi"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ExpandMoreIcon"><path d="M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></div></div><div class="MuiCollapse-root MuiCollapse-vertical MuiCollapse-hidden mui-a0y2e3" style="min-height: 0px;"><div class="MuiCollapse-wrapper MuiCollapse-vertical mui-hboir5"><div class="MuiCollapse-wrapperInner MuiCollapse-vertical mui-8atqhb"><div aria-labelledby="panel1bh-header" id="panel1bh-content" role="region" class="MuiAccordion-region"><div class="MuiAccordionDetails-root mui-u7qq7e"><h6 class="MuiTypography-root MuiTypography-body1 mui-1quhbks" id="approach-7">Approach</h6><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">One way we can get around the consistency issue all together is to just use Postgres with the appropriate extensions enabled.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Postgres has a geospatial extension called <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://postgis.net/" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">PostGIS</a> that can be used to index and query geographic data.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(166, 38, 164);">CREATE</span><span> EXTENSION </span><span class="token" style="color: rgb(166, 38, 164);">IF</span><span> </span><span class="token" style="color: rgb(64, 120, 242);">NOT</span><span> </span><span class="token" style="color: rgb(166, 38, 164);">EXISTS</span><span> postgis</span><span class="token" style="color: rgb(56, 58, 66);">;</span></code></div></div></pre><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Postgres also has a full text search extension called <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.postgresql.org/docs/current/pgtrgm.html" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">pg_trgm</a> that can be used to index and query text data.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(166, 38, 164);">CREATE</span><span> EXTENSION </span><span class="token" style="color: rgb(166, 38, 164);">IF</span><span> </span><span class="token" style="color: rgb(64, 120, 242);">NOT</span><span> </span><span class="token" style="color: rgb(166, 38, 164);">EXISTS</span><span> pg_trgm</span><span class="token" style="color: rgb(56, 58, 66);">;</span></code></div></div></pre><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/257707b6b00b4327f00e71d3ed4c4277"></div></div></div></div></div></div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">By using these extensions, we can create a geospatial index on the latitude and longitude columns and a full text search index on the business name and description columns without needing to introduce a new service.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Given that this is a small amount of data, <span class="MuiBox-root mui-1vu004u">10M businesses x 1kb each = 10GB</span> + <span class="MuiBox-root mui-1vu004u">10M businesses x 100 reviews each x 1kb = 1TB</span>, we don't need to worry too much about scaling, something that Elasticsearch excels at, so this is a perfectly reasonable solution.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">However, it's worth noting that while PostGIS is excellent for geospatial queries, it may not perform as well as Elasticsearch for full-text search at very large scales.</div></div></div></div></div></div></div></div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">In some cases, interviewers will ask that you don't use Elasticsearch as it simplifies the design too much. If this is the case, they're often looking for a few things in particular:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">They want you to determine and be able to talk about the correct geospatial indexing strategy. Essentially, this usually involves weighing the tradeoffs between geohashing and quadtrees, though more complex indexes like R-trees could be mentioned as well if you have familiarity. In my opinion, between geohashing and quadtrees, I'd opt for quadtrees since our updates are incredibly infrequent and businesses are clustered into densely populated regions (like NYC).</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Next, you'll want to talk about second pass filtering. This is the process by which you'll take the results of your geospatial query and further filter them by exact distance. This is done by calculating the distance between the user's lat/long and the business lat/long and filtering out any that are outside of the desired radius. Technically speaking, this is done with something called the Haversine formula, which is like the Pythagorean theorem but optimized for calculating distances on a sphere.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Lastly, interviewer will often be looking for you to articulate the sequencing of the phases. The goal here is to reduce the size of the search space as quickly as possible. Distance will typically be the most restrictive filter, so we want to apply that first. Once we have our smaller set of businesses, we can apply the other filters (name, category, etc) to that smaller set to finalize the results.</div></li>
</ol><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="4-how-would-you-modify-your-system-to-allow-searching-by-predefined-location-names-such-as-cities-or-neighborhoods">4) How would you modify your system to allow searching by predefined location names such as cities or neighborhoods?</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">For staff level candidates or senior candidates that moved quickly and accurately through the interview up until this point, I'll typically ask this follow up question to increase the complexity.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Our design currently supports searching based on a business's latitude and longitude. However, users often search using more natural language terms like city names or neighborhood names. For example, Pizza in NYC.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Notably, these location are not just zipcodes, states, or cities. They can also be more complex, like a neighborhood ie. The Mission in San Francisco.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">The first realization should be that a simple radius from a center point is insufficient for this use case. This is because city or neighborhoods are not perfectly circular and can have wildly different shapes. Instead, we need a way to define a polygon for each location and then check if any of the businesses are within that polygon.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">These polygons are just a list of points and come from a variety of sources. For example, <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://geojson.org/" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">GeoJSON</a> is a popular format for storing geographic data and includes functionality for working with polygons. They can also just be a list of coordinates that you can represent as a series of lat/long points.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">We simply need a way to:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Go from a location name to a polygon.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Use that polygon to filter a set of businesses that exist within it.</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Solving #1 is relatively straightforward. We can create a new table in our database that maps location names to polygons. These polygons can be sourced from various publicly available datasets (<a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.geoapify.com/download-all-the-cities-towns-villages/" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Geoapify</a> is one example).</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Then, to implement this:</div><ol style="list-style: outside decimal;">
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Create a <span class="MuiBox-root mui-1vu004u">locations</span> table with columns for <span class="MuiBox-root mui-1vu004u">name</span> (e.g., "San Francisco"), <span class="MuiBox-root mui-1vu004u">type</span> (e.g., "city", "neighborhood"), and <span class="MuiBox-root mui-1vu004u">polygon</span> (to store the geographic data).</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Populate this table with data from the chosen sources.</div></li>
<li class="MuiListItem-root MuiListItem-gutters MuiListItem-padding mui-ioa8ei"><div class="MuiBox-root mui-0">Index the <span class="MuiBox-root mui-1vu004u">name</span> column for efficient lookups.</div></li>
</ol><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">This approach allows us to quickly translate a location name into its corresponding polygon for use in geographic queries.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Now what about #2, once we have a polygon how do we use it to filter businesses?</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Conveniently, both Postgres via the PostGIS extension and Elasticsearch have functionality for working with polygons which they call <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://postgis.net/docs/reference.html#Geography_Shapes" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Geoshapes</a> or <a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">Geopoints</a> respectively.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">In the case of Elasticsearch, we can simply add a new <span class="MuiBox-root mui-1vu004u">geo_shape</span> field to our business documents and use the <span class="MuiBox-root mui-1vu004u">geo_shape</span> query to find businesses that exist within a polygon.</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>  </span><span class="token" style="color: rgb(228, 86, 73);">"query"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>    </span><span class="token" style="color: rgb(228, 86, 73);">"geo_bounding_box"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span> 
</span><span>      </span><span class="token" style="color: rgb(228, 86, 73);">"location"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>        </span><span class="token" style="color: rgb(228, 86, 73);">"top_left"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>          </span><span class="token" style="color: rgb(228, 86, 73);">"lat"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">42</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>          </span><span class="token" style="color: rgb(228, 86, 73);">"lon"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">-72</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>        </span><span class="token" style="color: rgb(228, 86, 73);">"bottom_right"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>          </span><span class="token" style="color: rgb(228, 86, 73);">"lat"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">40</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>          </span><span class="token" style="color: rgb(228, 86, 73);">"lon"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(183, 107, 1);">-74</span><span>
</span><span>        </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>      </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>    </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span>  </span><span class="token" style="color: rgb(56, 58, 66);">}</span><span>
</span><span></span><span class="token" style="color: rgb(56, 58, 66);">}</span></code></div></div></pre><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Doing this bounding box search on every request isn't that efficient though. We can do better.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Instead of filtering on bounding boxes for each request, we can pre-compute the areas for each business upon creation and store them as a list of location identifiers in our business table. These identifiers could be strings (like "san_francisco") or enums representing different areas.</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">For example, a business document in Elasticsearch might look like this:</div><pre><div class="MuiBox-root mui-xnilmx"><div class="MuiBox-root mui-v2ritd"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true" data-slot="icon" class="w-4 h-4  cursor-pointer" aria-label="Copy"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"></path></svg></div><div style="background: rgb(250, 250, 250); color: rgb(56, 58, 66); font-family: &quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; tab-size: 2; hyphens: none; padding: 1em; margin: 0px; overflow: auto; border-radius: 0.375rem; border: none;"><code font-size="18" style="white-space: pre;"><span class="token" style="color: rgb(56, 58, 66);">{</span><span>
</span><span>  </span><span class="token" style="color: rgb(228, 86, 73);">"id"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"123"</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>  </span><span class="token" style="color: rgb(228, 86, 73);">"name"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"Pizza Place"</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>  </span><span class="token" style="color: rgb(228, 86, 73);">"location_names"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(56, 58, 66);">[</span><span class="token" style="color: rgb(80, 161, 79);">"bay_area"</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span class="token" style="color: rgb(80, 161, 79);">"san_francisco"</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"mission_district"</span><span class="token" style="color: rgb(56, 58, 66);">]</span><span class="token" style="color: rgb(56, 58, 66);">,</span><span>
</span><span>  </span><span class="token" style="color: rgb(228, 86, 73);">"category"</span><span class="token" style="color: rgb(64, 120, 242);">:</span><span> </span><span class="token" style="color: rgb(80, 161, 79);">"restaurant"</span><span>
</span><span></span><span class="token" style="color: rgb(56, 58, 66);">}</span></code></div></div></pre><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">Now all we need is an inverted index on the <span class="MuiBox-root mui-1vu004u">location_names</span> field via a "keyword" field in ElasticSearch</div><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">By pre-computing the encompassing areas we avoid doing them on every request and only need to do them once when the business is created.</div><h2 class="MuiTypography-root MuiTypography-h3 mui-1rzqq5q" id="final-design">Final Design</h2><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">After applying all the deep dives, we may end up with a final design that looks like this:</div><div class="my-4 flex-col w-full undefined"><div class="MuiBox-root mui-10khgmf" style="cursor: pointer;"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column mui-1tdxmx0"><div class="MuiGrid-root MuiGrid-item mui-tolxbf"><div class="relative w-full"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall mui-wksd04" tabindex="0" type="button" aria-label="zoom-in"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium mui-10dohqv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ZoomInIcon"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14"></path><path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2z"></path></svg><span class="MuiTouchRipple-root mui-w0pj6f"></span></button><div class="w-full"><img class="w-full max-w-full max-h-full" src="https://d248djf5mc6iku.cloudfront.net/excalidraw/bd9f4cf2b861b2a592475da69ebc6152" alt="Yelp Final Design"></div></div></div><div class="MuiGrid-root MuiGrid-item mui-1wxaqej"><span class="MuiTypography-root MuiTypography-caption mui-17cupi8">Yelp Final Design</span></div></div></div></div><h2 class="MuiTypography-root MuiTypography-h3 mui-1rzqq5q" id="what-is-expected-at-each-level"><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineHover mui-pvpazu" href="https://www.hellointerview.com/blog/the-system-design-interview-what-is-expected-at-each-level" target="_blank" rel="noopener noreferrer" style="color: rgb(99, 115, 129); cursor: pointer; font-weight: 600; text-decoration: underline;">What is Expected at Each Level?</a></h2><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">So, what am I looking for at each level?</div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="mid-level">Mid-level</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">At mid-level, I'm mostly looking for a candidate's ability to create a working, high-level design while being able to reasonably answer my follow-up questions about average ratings and search optimizations. I don't expect them to know about database constraints necessarily, but I do want to see them problem solve and brainstorm ways to get the constraint closer to the persistence layer. I also don't expect in-depth knowledge of different types of indexing, but they should be able to apply the "correct" technologies to solve the problem.</div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="senior">Senior</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">For senior candidates, I expect that you nail the majority of the deep dives with the exception of "search by name string." I'm keeping an eye on your tendency to over-engineer and want to see strong justifications for your choices. You should understand the different types of indexes needed and should be able to weigh tradeoffs to choose the most effective technology.</div><h3 class="MuiTypography-root MuiTypography-h4 mui-hkpafq" id="staff">Staff+</h3><div class="MuiTypography-root MuiTypography-body1 mui-1p1f0ag">For staff candidates, I'm really evaluating your ability to recognize key insights and use them to derive simple solutions. Things like using Postgres extensions to avoid introducing a new technology (like Elasticsearch) and avoid the consistency issues, recognizing that the write throughput is tiny and thus we don't need a message queue. Identifying that the amount of data is also really small, so a simple read replica and/or cache is enough, no need to worry about sharding. Staff candidates are able to acknowledge what a complex solution could be and under what conditions it may be necessary, but articulate why, in this situation, the simple option suffices.</div></div>
</body>
</html>